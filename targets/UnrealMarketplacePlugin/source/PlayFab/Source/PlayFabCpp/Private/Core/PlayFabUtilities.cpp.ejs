<%- copyright %>

#include "PlayFabUtilities.h"
#include "Json.h"

using namespace PlayFab;

FString PlayFabUtilities::GetTempDir()
{
    // Unix
    FString tempDir = FPlatformMisc::GetEnvironmentVariable(TEXT("TEMPDIR"));
    if (tempDir.IsEmpty())
    {
        // Windows - Alternative 1
        tempDir = FPlatformMisc::GetEnvironmentVariable(TEXT("TEMP"));
    }
    if (tempDir.IsEmpty())
    {
        // Windows - Alternative 2
        tempDir = FPlatformMisc::GetEnvironmentVariable(TEXT("TMP"));
    }
    return tempDir;
}

FString PlayFabUtilities::GetLocalSettingsFileContent()
{
    FString tempDirPath = PlayFabUtilities::GetTempDir();
    FString localSettingsFilePath = FPaths::Combine(tempDirPath, TEXT("playfab.local.settings.json"));
    FString localSettingsFileContent = "";
    return FFileHelper::LoadFileToString(localSettingsFileContent, *localSettingsFilePath)
        ? localSettingsFileContent
        : FString();
}

TSharedPtr<FJsonObject> PlayFabUtilities::GetLocalSettingsFileJson()
{
    FString fileContent = PlayFabUtilities::GetLocalSettingsFileContent();
    TSharedPtr<FJsonObject> JsonObject = MakeShareable(new FJsonObject());
    TSharedRef<TJsonReader<>> JsonReader = TJsonReaderFactory<>::Create(fileContent);
    return (FJsonSerializer::Deserialize(JsonReader, JsonObject) && JsonObject.IsValid())
        ? JsonObject
        : MakeShareable(new FJsonObject);
}

FString PlayFabUtilities::GetLocalSettingsFileProperty(const FString& propertyKey)
{
    TSharedPtr<FJsonObject> jsonObject = PlayFabUtilities::GetLocalSettingsFileJson();
    FString outString;
    return jsonObject->TryGetStringField(propertyKey, outString) ? outString : FString();
}

TArray<FString> PlayFabUtilities::GetLocalSettingsFileArrayProperty(const FString& propertyKey)
{
    TSharedPtr<FJsonObject> jsonObject = PlayFabUtilities::GetLocalSettingsFileJson();
    TArray<FString> jsonArray;
    return jsonObject->TryGetStringArrayField(propertyKey, jsonArray) ? jsonArray : TArray<FString>();
}